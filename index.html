<html lang="zh-cn">
    <head>
        <meta charset="UTF-8" />
        <title>Last Update Time</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .update-time { font-size: 1.5em; color: #2d8cf0; }
            label { display: inline-block; width: 140px; }
            input[readonly] { margin-bottom: 6px; }
            table { border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ccc; padding: 4px 8px; font-size: 14px; }
            th { background: #f5f5f5; }
        </style>
    </head>
    <body>
        <h1>UNF-Aktivite-ics</h1>
        <h2>Last Update Time</h2>
        <div class="update-time" id="update-time">
            <span id="last-update-utc">UTC: null</span><br />
            <span id="last-update-local">Local: null</span>
        </div>

        <h2>ICS订阅链接</h2>
        <div id="ics-links"></div>

        <h2>已发布文件列表</h2>
        <div id="file-list">
            <!-- FILE_LIST_START -->
            <!-- FILE_LIST_END -->
        </div>

        <h2>事件调试视图 (CSV)</h2>
        <div id="csv-view" style="max-width:100%;overflow:auto;"></div>

        <script>
            // 动态插入 ICS 订阅链接, 文件名与 Python 同步
            const icsFiles = [
                { slug: 'kbh', name: 'UNF København' },
                { slug: 'lyngby', name: 'UNF Lyngby' },
                { slug: 'aalborg', name: 'UNF Aalborg' },
                { slug: 'aarhus', name: 'UNF Aarhus' },
                { slug: 'danmark', name: 'UNF Danmark' },
                { slug: 'odense', name: 'UNF Odense' }
            ];
            const baseUrl = `https://teddypyf.github.io/UNF-Aktivite-Web-Scraper/`;
            let html = '';
            icsFiles.forEach((f, i) => {
                const fname = `unf_events_${f.slug}.ics`;
                html += `<label for="ics-link${i}">${f.name}:</label>`;
                html += `<input id="ics-link${i}" type="text" value="${baseUrl}${fname}" readonly style="width:500px;" onclick="this.select()" /><br />`;
            });
            document.getElementById('ics-links').innerHTML = html;
        </script>
        <script>
            // 渲染 CSV (combined) 如果存在
            async function loadCSV() {
                const target = 'unf_events_all.csv';
                try {
                    const resp = await fetch(target, {cache: 'no-store'});
                    if (!resp.ok) { return; }
                    const text = await resp.text();
                    const lines = text.trim().split(/\r?\n/);
                    if (lines.length === 0) return;
                    const table = document.createElement('table');
                    table.style.borderCollapse = 'collapse';
                    table.style.marginTop = '8px';
                    const mkRow = (cells, tag) => {
                        const tr = document.createElement('tr');
                        cells.forEach(c => {
                            const el = document.createElement(tag);
                            el.textContent = c;
                            el.style.border = '1px solid #ccc';
                            el.style.padding = '2px 6px';
                            el.style.fontSize = '12px';
                            tr.appendChild(el);
                        });
                        return tr;
                    };
                    const headers = lines[0].split(',');
                    table.appendChild(mkRow(headers, 'th'));
                    for (let i=1;i<lines.length;i++) {
                        const row = lines[i];
                        if (!row.trim()) continue;
                        const cells = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/); // 简单分割
                        table.appendChild(mkRow(cells, 'td'));
                    }
                    const wrap = document.getElementById('csv-view');
                    wrap.innerHTML = '';
                    wrap.appendChild(table);
                } catch(e) {
                    console.warn('CSV load failed', e);
                }
            }
            loadCSV();
        </script>
        <script>
            // 将 UTC 时间转换为本地时间显示
            const utcSpan = document.getElementById('last-update-utc');
            const localSpan = document.getElementById('last-update-local');
            let utcText = utcSpan.textContent;
            let match = utcText.match(/UTC: (\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
            if (match) {
                let utcDate = new Date(match[1] + ' UTC');
                function pad(n) { return n < 10 ? '0' + n : n; }
                function formatDate(d) {
                    return (
                        d.getFullYear() +
                        '-' + pad(d.getMonth() + 1) +
                        '-' + pad(d.getDate()) +
                        ' ' + pad(d.getHours()) +
                        ':' + pad(d.getMinutes()) +
                        ':' + pad(d.getSeconds())
                    );
                }
                utcSpan.textContent = 'UTC: ' + formatDate(utcDate);
                localSpan.textContent = 'Local: ' + formatDate(
                    new Date(utcDate.getTime() + utcDate.getTimezoneOffset() * 60000 * -1)
                );
            }
        </script>
    </body>
</html>
